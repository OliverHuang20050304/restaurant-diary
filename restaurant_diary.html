<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„é¤å»³æ—¥è¨˜ - å“å‘³ç”Ÿæ´»çš„æ¯ä¸€åˆ»</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #8B7355;
            --secondary-color: #D4C4B0;
            --accent-color: #C9A961;
            --text-dark: #2C2C2C;
            --text-light: #6B6B6B;
            --bg-light: #FAF8F5;
            --bg-white: #FFFFFF;
            --border-color: #E8E3DB;
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            --shadow-hover: 0 8px 30px rgba(0, 0, 0, 0.12);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft JhengHei', 'PingFang TC', sans-serif;
            background: var(--bg-light);
            color: var(--text-dark);
            line-height: 1.6;
        }

        /* Header */
        header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--accent-color) 100%);
            color: white;
            padding: 3rem 2rem;
            text-align: center;
            box-shadow: var(--shadow);
            position: relative;
        }

        header h1 {
            font-size: 2.5rem;
            font-weight: 300;
            letter-spacing: 2px;
            margin-bottom: 0.5rem;
        }

        header p {
            font-size: 1.1rem;
            opacity: 0.95;
            font-weight: 300;
        }

        .user-info {
            position: absolute;
            top: 1rem;
            right: 2rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .user-name {
            font-size: 1rem;
            opacity: 0.95;
        }

        .logout-btn {
            padding: 0.5rem 1rem;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
        }

        @media (max-width: 768px) {
            .user-info {
                position: static;
                justify-content: center;
                margin-top: 1rem;
            }
        }

        /* Container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Stats Bar */
        .stats-bar {
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin: 2rem 0;
            flex-wrap: wrap;
        }

        .stat-card {
            background: var(--bg-white);
            padding: 1.5rem 2rem;
            border-radius: 12px;
            box-shadow: var(--shadow);
            text-align: center;
            min-width: 150px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-hover);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }

        .stat-label {
            font-size: 0.9rem;
            color: var(--text-light);
        }

        /* Controls */
        .controls {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .search-box {
            flex: 1;
            min-width: 250px;
            position: relative;
        }

        .search-box input {
            width: 100%;
            padding: 0.9rem 1rem 0.9rem 2.5rem;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
            background: var(--bg-white);
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .search-box::before {
            content: 'ğŸ”';
            position: absolute;
            left: 0.8rem;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.2rem;
        }

        .filter-group {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 0.9rem 1.5rem;
            border: 2px solid var(--border-color);
            background: var(--bg-white);
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95rem;
            transition: all 0.3s ease;
            color: var(--text-dark);
        }

        .filter-btn:hover {
            border-color: var(--primary-color);
            background: var(--secondary-color);
        }

        .filter-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .btn-primary {
            padding: 0.9rem 2rem;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: var(--shadow);
        }

        .btn-primary:hover {
            background: var(--accent-color);
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }

        /* Restaurant Grid */
        .restaurant-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 2rem;
            margin-top: 2rem;
        }

        .restaurant-card {
            background: var(--bg-white);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .restaurant-card:hover {
            transform: translateY(-8px);
            box-shadow: var(--shadow-hover);
        }

        .restaurant-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
            background: linear-gradient(135deg, var(--secondary-color) 0%, var(--accent-color) 100%);
        }

        .restaurant-content {
            padding: 1.5rem;
        }

        .restaurant-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .restaurant-name {
            font-size: 1.4rem;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 0.3rem;
        }

        .restaurant-category {
            display: inline-block;
            padding: 0.3rem 0.8rem;
            background: var(--secondary-color);
            color: var(--primary-color);
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
            margin-top: 0.5rem;
        }

        .restaurant-rating {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin: 0.5rem 0;
        }

        .stars {
            color: #FFD700;
            font-size: 1.2rem;
        }

        .rating-text {
            color: var(--text-light);
            font-size: 0.9rem;
        }

        .restaurant-info {
            color: var(--text-light);
            font-size: 0.95rem;
            margin: 0.5rem 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .restaurant-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
        }

        .btn-icon {
            flex: 1;
            padding: 0.6rem;
            border: 1px solid var(--border-color);
            background: var(--bg-white);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .btn-icon:hover {
            background: var(--secondary-color);
            border-color: var(--primary-color);
        }

        .btn-icon.favorite {
            color: #E74C3C;
        }

        .btn-icon.favorite.active {
            background: #FFE5E5;
            border-color: #E74C3C;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        .modal-content {
            background: var(--bg-white);
            border-radius: 20px;
            width: 100%;
            max-width: 700px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                transform: translateY(50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            padding: 2rem 2rem 1rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            font-size: 1.8rem;
            font-weight: 600;
            color: var(--text-dark);
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 2rem;
            cursor: pointer;
            color: var(--text-light);
            transition: color 0.3s ease;
        }

        .close-btn:hover {
            color: var(--text-dark);
        }

        .modal-body {
            padding: 2rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-dark);
            font-weight: 500;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.9rem;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            font-family: inherit;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .rating-input {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .star-input {
            font-size: 2rem;
            cursor: pointer;
            color: #DDD;
            transition: color 0.2s ease;
        }

        .star-input:hover,
        .star-input.active {
            color: #FFD700;
        }

        .map-container {
            width: 100%;
            height: 300px;
            border-radius: 8px;
            overflow: hidden;
            margin-top: 1rem;
            border: 2px solid var(--border-color);
        }

        .form-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border-color);
        }

        .btn-secondary {
            padding: 0.9rem 2rem;
            background: var(--bg-white);
            color: var(--text-dark);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .btn-secondary:hover {
            background: var(--bg-light);
            border-color: var(--primary-color);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-light);
        }

        .empty-state-icon {
            font-size: 5rem;
            margin-bottom: 1rem;
        }

        .empty-state h3 {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
            color: var(--text-dark);
        }

        /* Responsive */
        @media (max-width: 768px) {
            header h1 {
                font-size: 2rem;
            }

            .restaurant-grid {
                grid-template-columns: 1fr;
            }

            .controls {
                flex-direction: column;
            }

            .search-box {
                width: 100%;
            }
        }

        /* Loading Animation */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid var(--border-color);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Auth Modal Styles */
        .auth-modal-content {
            max-width: 450px;
        }

        .auth-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid var(--border-color);
        }

        .auth-tab {
            flex: 1;
            padding: 1rem;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            color: var(--text-light);
            transition: all 0.3s ease;
        }

        .auth-tab:hover {
            color: var(--text-dark);
        }

        .auth-tab.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }

        .auth-form {
            display: none;
        }

        .auth-form.active {
            display: block;
        }

        .error-message {
            background: #FFE5E5;
            color: #E74C3C;
            padding: 0.8rem;
            border-radius: 6px;
            margin-bottom: 1rem;
            font-size: 0.9rem;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        .success-message {
            background: #E5F7E5;
            color: #27AE60;
            padding: 0.8rem;
            border-radius: 6px;
            margin-bottom: 1rem;
            font-size: 0.9rem;
            display: none;
        }

        .success-message.show {
            display: block;
        }

        .password-requirements {
            font-size: 0.85rem;
            color: var(--text-light);
            margin-top: 0.5rem;
        }

        .password-requirements ul {
            margin: 0.5rem 0 0 1.5rem;
            padding: 0;
        }

        .password-requirements li {
            margin: 0.3rem 0;
        }

        /* Main Content - Hidden when not logged in */
        .main-content {
            display: block;
        }

        .main-content.hidden {
            display: none;
        }
    </style>
</head>
<body>
    <header>
        <h1>æˆ‘çš„é¤å»³æ—¥è¨˜</h1>
        <p>è¨˜éŒ„æ¯ä¸€é¤çš„ç¾å¥½æ™‚å…‰</p>
        <div class="user-info" id="userInfo" style="display: none;">
            <span class="user-name" id="userName"></span>
            <button class="logout-btn" onclick="logout()">ç™»å‡º</button>
        </div>
    </header>

    <!-- Auth Modal -->
    <div class="modal active" id="authModal">
        <div class="modal-content auth-modal-content">
            <div class="modal-header">
                <h2>æ­¡è¿ä½¿ç”¨é¤å»³æ—¥è¨˜</h2>
            </div>
            <div class="modal-body">
                <div class="auth-tabs">
                    <button class="auth-tab active" onclick="switchAuthTab('login')">ç™»å…¥</button>
                    <button class="auth-tab" onclick="switchAuthTab('register')">è¨»å†Š</button>
                </div>

                <!-- Login Form -->
                <form id="loginForm" class="auth-form active">
                    <div class="error-message" id="loginError"></div>
                    
                    <div class="form-group">
                        <label for="loginUsername">ä½¿ç”¨è€…åç¨± *</label>
                        <input type="text" id="loginUsername" required autocomplete="username">
                    </div>

                    <div class="form-group">
                        <label for="loginPassword">å¯†ç¢¼ *</label>
                        <input type="password" id="loginPassword" required autocomplete="current-password">
                    </div>

                    <div class="form-actions">
                        <button type="submit" class="btn-primary" style="width: 100%;">ç™»å…¥</button>
                    </div>
                </form>

                <!-- Register Form -->
                <form id="registerForm" class="auth-form">
                    <div class="error-message" id="registerError"></div>
                    <div class="success-message" id="registerSuccess"></div>
                    
                    <div class="form-group">
                        <label for="registerUsername">ä½¿ç”¨è€…åç¨± *</label>
                        <input type="text" id="registerUsername" required autocomplete="username" minlength="3" maxlength="20">
                        <small style="color: var(--text-light);">3-20 å€‹å­—å…ƒ</small>
                    </div>

                    <div class="form-group">
                        <label for="registerPassword">å¯†ç¢¼ *</label>
                        <input type="password" id="registerPassword" required autocomplete="new-password" minlength="6">
                        <div class="password-requirements">
                            <small>å¯†ç¢¼è¦æ±‚ï¼š</small>
                            <ul>
                                <li>è‡³å°‘ 6 å€‹å­—å…ƒ</li>
                                <li>å»ºè­°åŒ…å«å­—æ¯å’Œæ•¸å­—</li>
                            </ul>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="registerPasswordConfirm">ç¢ºèªå¯†ç¢¼ *</label>
                        <input type="password" id="registerPasswordConfirm" required autocomplete="new-password">
                    </div>

                    <div class="form-actions">
                        <button type="submit" class="btn-primary" style="width: 100%;">è¨»å†Š</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="container main-content" id="mainContent">
        <!-- Statistics -->
        <div class="stats-bar">
            <div class="stat-card">
                <div class="stat-number" id="totalRestaurants">0</div>
                <div class="stat-label">ç¸½é¤å»³æ•¸</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalCategories">0</div>
                <div class="stat-label">åˆ†é¡æ•¸</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="avgRating">0.0</div>
                <div class="stat-label">å¹³å‡è©•åˆ†</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="favoriteCount">0</div>
                <div class="stat-label">æ”¶è—æ•¸</div>
            </div>
        </div>

        <!-- Controls -->
        <div class="controls">
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="æœå°‹é¤å»³åç¨±ã€åœ°å€æˆ–è©•è«–...">
            </div>
            <div class="filter-group">
                <button class="filter-btn active" data-category="all">å…¨éƒ¨</button>
                <button class="filter-btn" data-category="ä¸­å¼">ä¸­å¼</button>
                <button class="filter-btn" data-category="è¥¿å¼">è¥¿å¼</button>
                <button class="filter-btn" data-category="æ—¥å¼">æ—¥å¼</button>
                <button class="filter-btn" data-category="éŸ“å¼">éŸ“å¼</button>
                <button class="filter-btn" data-category="ç”œé»">ç”œé»</button>
                <button class="filter-btn" data-category="å’–å•¡">å’–å•¡</button>
                <button class="filter-btn" data-category="å…¶ä»–">å…¶ä»–</button>
            </div>
            <button class="btn-primary" onclick="openAddModal()">+ æ–°å¢é¤å»³</button>
        </div>

        <!-- Restaurant Grid -->
        <div class="restaurant-grid" id="restaurantGrid">
            <!-- Restaurants will be dynamically inserted here -->
        </div>

        <!-- Empty State -->
        <div class="empty-state" id="emptyState" style="display: none;">
            <div class="empty-state-icon">ğŸ½ï¸</div>
            <h3>é‚„æ²’æœ‰è¨˜éŒ„ä»»ä½•é¤å»³</h3>
            <p>é»æ“Šã€Œæ–°å¢é¤å»³ã€é–‹å§‹è¨˜éŒ„ä½ çš„ç¾é£Ÿä¹‹æ—…å§ï¼</p>
        </div>
    </div>

    <!-- Add/Edit Modal -->
    <div class="modal" id="restaurantModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">æ–°å¢é¤å»³</h2>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="restaurantForm">
                    <input type="hidden" id="restaurantId">
                    
                    <div class="form-group">
                        <label for="restaurantName">é¤å»³åç¨± *</label>
                        <input type="text" id="restaurantName" required>
                    </div>

                    <div class="form-group">
                        <label for="restaurantCategory">åˆ†é¡ *</label>
                        <select id="restaurantCategory" required>
                            <option value="">è«‹é¸æ“‡åˆ†é¡</option>
                            <option value="ä¸­å¼">ä¸­å¼</option>
                            <option value="è¥¿å¼">è¥¿å¼</option>
                            <option value="æ—¥å¼">æ—¥å¼</option>
                            <option value="éŸ“å¼">éŸ“å¼</option>
                            <option value="ç”œé»">ç”œé»</option>
                            <option value="å’–å•¡">å’–å•¡</option>
                            <option value="å…¶ä»–">å…¶ä»–</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="restaurantAddress">åœ°å€ *</label>
                        <input type="text" id="restaurantAddress" required placeholder="ä¾‹å¦‚ï¼šå°åŒ—å¸‚ä¿¡ç¾©å€ä¿¡ç¾©è·¯äº”æ®µ7è™Ÿ">
                    </div>

                    <div class="form-group">
                        <label>è©•åˆ† *</label>
                        <div class="rating-input">
                            <span class="star-input" data-rating="1" onclick="setRating(1)">â˜†</span>
                            <span class="star-input" data-rating="2" onclick="setRating(2)">â˜†</span>
                            <span class="star-input" data-rating="3" onclick="setRating(3)">â˜†</span>
                            <span class="star-input" data-rating="4" onclick="setRating(4)">â˜†</span>
                            <span class="star-input" data-rating="5" onclick="setRating(5)">â˜†</span>
                            <span id="ratingText" style="margin-left: 1rem; color: var(--text-light);">æœªè©•åˆ†</span>
                        </div>
                        <input type="hidden" id="restaurantRating" required>
                    </div>

                    <div class="form-group">
                        <label for="visitDate">é€ è¨ªæ—¥æœŸ</label>
                        <input type="date" id="visitDate">
                    </div>

                    <div class="form-group">
                        <label for="priceRange">åƒ¹æ ¼ç¯„åœ</label>
                        <select id="priceRange">
                            <option value="">è«‹é¸æ“‡</option>
                            <option value="$">$ - å¹³åƒ¹</option>
                            <option value="$$">$$ - ä¸­ç­‰</option>
                            <option value="$$$">$$$ - é«˜åƒ¹</option>
                            <option value="$$$$">$$$$ - å¥¢è¯</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="restaurantNotes">è©•è«–/ç­†è¨˜</label>
                        <textarea id="restaurantNotes" placeholder="è¨˜éŒ„é€™å®¶é¤å»³çš„ç‰¹è‰²ã€æ¨è–¦èœè‰²ã€ç”¨é¤æ„Ÿå—..."></textarea>
                    </div>

                    <div class="form-group">
                        <label for="restaurantImage">ç…§ç‰‡ç¶²å€</label>
                        <input type="url" id="restaurantImage" placeholder="https://example.com/image.jpg">
                    </div>

                    <div class="form-group">
                        <label>åœ°åœ–ä½ç½®</label>
                        <div class="map-container" id="mapContainer">
                            <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--text-light);">
                                è¼¸å…¥åœ°å€å¾Œå°‡é¡¯ç¤ºåœ°åœ–
                            </div>
                        </div>
                        <small style="color: var(--text-light); margin-top: 0.5rem; display: block;">
                            æç¤ºï¼šè¼¸å…¥åœ°å€å¾Œï¼Œé»æ“Šä¸‹æ–¹æŒ‰éˆ•å¯åœ¨ Google Maps ä¸­æŸ¥çœ‹
                        </small>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn-secondary" onclick="closeModal()">å–æ¶ˆ</button>
                        <button type="submit" class="btn-primary">å„²å­˜</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Authentication & User Management
        let currentUser = null;
        let restaurants = [];
        let currentFilter = 'all';
        let currentSearch = '';
        let currentRating = 0;
        let editingId = null;
        let map = null;
        let geocoder = null;

        // Simple password hashing (for demonstration - not cryptographically secure)
        async function hashPassword(password) {
            const encoder = new TextEncoder();
            const data = encoder.encode(password);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        // User Management Functions
        function getUsers() {
            return JSON.parse(localStorage.getItem('users')) || {};
        }

        function saveUsers(users) {
            localStorage.setItem('users', JSON.stringify(users));
        }

        function getUserDataKey(username) {
            return `restaurants_${username}`;
        }

        function loadUserRestaurants() {
            if (!currentUser) return [];
            const key = getUserDataKey(currentUser);
            return JSON.parse(localStorage.getItem(key)) || [];
        }

        function saveUserRestaurants(data) {
            if (!currentUser) return;
            const key = getUserDataKey(currentUser);
            localStorage.setItem(key, JSON.stringify(data));
        }

        function checkLoginStatus() {
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = savedUser;
                restaurants = loadUserRestaurants();
                showMainContent();
            } else {
                showAuthModal();
            }
        }

        function showAuthModal() {
            document.getElementById('authModal').classList.add('active');
            document.getElementById('mainContent').classList.add('hidden');
            document.getElementById('userInfo').style.display = 'none';
        }

        function showMainContent() {
            document.getElementById('authModal').classList.remove('active');
            document.getElementById('mainContent').classList.remove('hidden');
            document.getElementById('userInfo').style.display = 'flex';
            document.getElementById('userName').textContent = `æ­¡è¿ï¼Œ${currentUser}`;
            renderRestaurants();
            updateStats();
        }

        // Auth Tab Switching
        function switchAuthTab(tab) {
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
            
            if (tab === 'login') {
                document.querySelector('.auth-tab[onclick="switchAuthTab(\'login\')"]').classList.add('active');
                document.getElementById('loginForm').classList.add('active');
            } else {
                document.querySelector('.auth-tab[onclick="switchAuthTab(\'register\')"]').classList.add('active');
                document.getElementById('registerForm').classList.add('active');
            }
            
            // Clear error messages
            document.getElementById('loginError').classList.remove('show');
            document.getElementById('registerError').classList.remove('show');
            document.getElementById('registerSuccess').classList.remove('show');
        }

        // Login
        async function handleLogin(e) {
            e.preventDefault();
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            const errorEl = document.getElementById('loginError');

            if (!username || !password) {
                errorEl.textContent = 'è«‹è¼¸å…¥ä½¿ç”¨è€…åç¨±å’Œå¯†ç¢¼';
                errorEl.classList.add('show');
                return;
            }

            const users = getUsers();
            const hashedPassword = await hashPassword(password);

            if (users[username] && users[username].password === hashedPassword) {
                currentUser = username;
                localStorage.setItem('currentUser', username);
                restaurants = loadUserRestaurants();
                errorEl.classList.remove('show');
                showMainContent();
            } else {
                errorEl.textContent = 'ä½¿ç”¨è€…åç¨±æˆ–å¯†ç¢¼éŒ¯èª¤';
                errorEl.classList.add('show');
            }
        }

        // Register
        async function handleRegister(e) {
            e.preventDefault();
            const username = document.getElementById('registerUsername').value.trim();
            const password = document.getElementById('registerPassword').value;
            const passwordConfirm = document.getElementById('registerPasswordConfirm').value;
            const errorEl = document.getElementById('registerError');
            const successEl = document.getElementById('registerSuccess');

            // Validation
            if (!username || !password || !passwordConfirm) {
                errorEl.textContent = 'è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½';
                errorEl.classList.add('show');
                return;
            }

            if (username.length < 3 || username.length > 20) {
                errorEl.textContent = 'ä½¿ç”¨è€…åç¨±é•·åº¦éœ€åœ¨ 3-20 å€‹å­—å…ƒä¹‹é–“';
                errorEl.classList.add('show');
                return;
            }

            if (password.length < 6) {
                errorEl.textContent = 'å¯†ç¢¼é•·åº¦è‡³å°‘éœ€è¦ 6 å€‹å­—å…ƒ';
                errorEl.classList.add('show');
                return;
            }

            if (password !== passwordConfirm) {
                errorEl.textContent = 'å…©æ¬¡è¼¸å…¥çš„å¯†ç¢¼ä¸ä¸€è‡´';
                errorEl.classList.add('show');
                return;
            }

            const users = getUsers();
            if (users[username]) {
                errorEl.textContent = 'è©²ä½¿ç”¨è€…åç¨±å·²è¢«ä½¿ç”¨';
                errorEl.classList.add('show');
                return;
            }

            // Register new user
            const hashedPassword = await hashPassword(password);
            users[username] = {
                password: hashedPassword,
                createdAt: new Date().toISOString()
            };
            saveUsers(users);

            // Initialize user's restaurant data
            const userDataKey = getUserDataKey(username);
            localStorage.setItem(userDataKey, JSON.stringify([]));

            errorEl.classList.remove('show');
            successEl.textContent = 'è¨»å†ŠæˆåŠŸï¼æ­£åœ¨åˆ‡æ›åˆ°ç™»å…¥é é¢...';
            successEl.classList.add('show');

            // Switch to login after 1.5 seconds
            setTimeout(() => {
                document.getElementById('registerForm').reset();
                switchAuthTab('login');
                document.getElementById('loginUsername').value = username;
            }, 1500);
        }

        // Logout
        function logout() {
            if (confirm('ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ')) {
                currentUser = null;
                restaurants = [];
                localStorage.removeItem('currentUser');
                showAuthModal();
                // Clear forms
                document.getElementById('loginForm').reset();
                document.getElementById('registerForm').reset();
                document.getElementById('loginError').classList.remove('show');
                document.getElementById('registerError').classList.remove('show');
                document.getElementById('registerSuccess').classList.remove('show');
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            checkLoginStatus();
            setupEventListeners();
            
            // Auth form event listeners
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('registerForm').addEventListener('submit', handleRegister);
        });

        // Event Listeners
        function setupEventListeners() {
            document.getElementById('searchInput').addEventListener('input', function(e) {
                currentSearch = e.target.value.toLowerCase();
                renderRestaurants();
            });

            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentFilter = this.dataset.category;
                    renderRestaurants();
                });
            });

            document.getElementById('restaurantForm').addEventListener('submit', function(e) {
                e.preventDefault();
                saveRestaurant();
            });

            document.getElementById('restaurantAddress').addEventListener('blur', function() {
                updateMapPreview();
            });

            // Close modal on outside click
            document.getElementById('restaurantModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeModal();
                }
            });
        }

        // Rating System
        function setRating(rating) {
            currentRating = rating;
            document.getElementById('restaurantRating').value = rating;
            
            const stars = document.querySelectorAll('.star-input');
            const ratingText = document.getElementById('ratingText');
            const texts = ['', 'å¾ˆå·®', 'æ™®é€š', 'ä¸éŒ¯', 'å¾ˆå¥½', 'æ¥µä½³'];
            
            stars.forEach((star, index) => {
                if (index < rating) {
                    star.classList.add('active');
                    star.textContent = 'â˜…';
                } else {
                    star.classList.remove('active');
                    star.textContent = 'â˜†';
                }
            });
            
            ratingText.textContent = texts[rating] || 'æœªè©•åˆ†';
        }

        // Map Functions
        function updateMapPreview() {
            const address = document.getElementById('restaurantAddress').value;
            if (!address) return;

            const mapContainer = document.getElementById('mapContainer');
            const encodedAddress = encodeURIComponent(address);
            const mapUrl = `https://www.google.com/maps/embed/v1/place?key=YOUR_API_KEY&q=${encodedAddress}`;
            
            // For demo purposes, we'll use a static map or link
            mapContainer.innerHTML = `
                <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; padding: 1rem; text-align: center;">
                    <div style="color: var(--text-light); margin-bottom: 1rem;">ğŸ“ ${address}</div>
                    <a href="https://www.google.com/maps/search/?api=1&query=${encodedAddress}" 
                       target="_blank" 
                       style="padding: 0.8rem 1.5rem; background: var(--primary-color); color: white; border-radius: 8px; text-decoration: none; font-weight: 500;">
                        åœ¨ Google Maps ä¸­é–‹å•Ÿ
                    </a>
                </div>
            `;
        }

        // Modal Functions
        function openAddModal() {
            editingId = null;
            document.getElementById('modalTitle').textContent = 'æ–°å¢é¤å»³';
            document.getElementById('restaurantForm').reset();
            currentRating = 0;
            document.querySelectorAll('.star-input').forEach(star => {
                star.classList.remove('active');
                star.textContent = 'â˜†';
            });
            document.getElementById('ratingText').textContent = 'æœªè©•åˆ†';
            document.getElementById('mapContainer').innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--text-light);">è¼¸å…¥åœ°å€å¾Œå°‡é¡¯ç¤ºåœ°åœ–</div>';
            document.getElementById('restaurantModal').classList.add('active');
        }

        function openEditModal(id) {
            const restaurant = restaurants.find(r => r.id === id);
            if (!restaurant) return;

            editingId = id;
            document.getElementById('modalTitle').textContent = 'ç·¨è¼¯é¤å»³';
            document.getElementById('restaurantId').value = id;
            document.getElementById('restaurantName').value = restaurant.name;
            document.getElementById('restaurantCategory').value = restaurant.category;
            document.getElementById('restaurantAddress').value = restaurant.address;
            document.getElementById('visitDate').value = restaurant.visitDate || '';
            document.getElementById('priceRange').value = restaurant.priceRange || '';
            document.getElementById('restaurantNotes').value = restaurant.notes || '';
            document.getElementById('restaurantImage').value = restaurant.image || '';
            
            setRating(restaurant.rating);
            updateMapPreview();
            
            document.getElementById('restaurantModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('restaurantModal').classList.remove('active');
            editingId = null;
        }

        // CRUD Operations
        function saveRestaurant() {
            const formData = {
                id: editingId || Date.now().toString(),
                name: document.getElementById('restaurantName').value.trim(),
                category: document.getElementById('restaurantCategory').value,
                address: document.getElementById('restaurantAddress').value.trim(),
                rating: parseInt(document.getElementById('restaurantRating').value),
                visitDate: document.getElementById('visitDate').value,
                priceRange: document.getElementById('priceRange').value,
                notes: document.getElementById('restaurantNotes').value.trim(),
                image: document.getElementById('restaurantImage').value.trim(),
                favorite: editingId ? restaurants.find(r => r.id === editingId)?.favorite || false : false,
                createdAt: editingId ? restaurants.find(r => r.id === editingId)?.createdAt : new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };

            if (editingId) {
                const index = restaurants.findIndex(r => r.id === editingId);
                if (index !== -1) {
                    restaurants[index] = formData;
                }
            } else {
                restaurants.push(formData);
            }

            saveUserRestaurants(restaurants);
            renderRestaurants();
            updateStats();
            closeModal();
        }

        function deleteRestaurant(id) {
            if (confirm('ç¢ºå®šè¦åˆªé™¤é€™å®¶é¤å»³çš„è¨˜éŒ„å—ï¼Ÿ')) {
                restaurants = restaurants.filter(r => r.id !== id);
                saveUserRestaurants(restaurants);
                renderRestaurants();
                updateStats();
            }
        }

        function toggleFavorite(id) {
            const restaurant = restaurants.find(r => r.id === id);
            if (restaurant) {
                restaurant.favorite = !restaurant.favorite;
                saveUserRestaurants(restaurants);
                renderRestaurants();
                updateStats();
            }
        }

        // Render Functions
        function renderRestaurants() {
            const grid = document.getElementById('restaurantGrid');
            const emptyState = document.getElementById('emptyState');

            let filtered = restaurants.filter(restaurant => {
                const matchCategory = currentFilter === 'all' || restaurant.category === currentFilter;
                const matchSearch = !currentSearch || 
                    restaurant.name.toLowerCase().includes(currentSearch) ||
                    restaurant.address.toLowerCase().includes(currentSearch) ||
                    (restaurant.notes && restaurant.notes.toLowerCase().includes(currentSearch));
                return matchCategory && matchSearch;
            });

            if (filtered.length === 0) {
                grid.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }

            grid.style.display = 'grid';
            emptyState.style.display = 'none';

            // Sort by favorite first, then by date
            filtered.sort((a, b) => {
                if (a.favorite && !b.favorite) return -1;
                if (!a.favorite && b.favorite) return 1;
                return new Date(b.updatedAt) - new Date(a.updatedAt);
            });

            grid.innerHTML = filtered.map(restaurant => `
                <div class="restaurant-card">
                    ${restaurant.image ? 
                        `<img src="${restaurant.image}" alt="${restaurant.name}" class="restaurant-image" onerror="this.style.display='none'">` :
                        `<div class="restaurant-image"></div>`
                    }
                    <div class="restaurant-content">
                        <div class="restaurant-header">
                            <div>
                                <div class="restaurant-name">${restaurant.name}</div>
                                <span class="restaurant-category">${restaurant.category}</span>
                            </div>
                        </div>
                        <div class="restaurant-rating">
                            <div class="stars">${'â˜…'.repeat(restaurant.rating)}${'â˜†'.repeat(5 - restaurant.rating)}</div>
                            <span class="rating-text">${restaurant.rating}/5</span>
                        </div>
                        <div class="restaurant-info">
                            ğŸ“ ${restaurant.address}
                        </div>
                        ${restaurant.visitDate ? `
                            <div class="restaurant-info">
                                ğŸ“… ${new Date(restaurant.visitDate).toLocaleDateString('zh-TW')}
                            </div>
                        ` : ''}
                        ${restaurant.priceRange ? `
                            <div class="restaurant-info">
                                ğŸ’° ${restaurant.priceRange}
                            </div>
                        ` : ''}
                        ${restaurant.notes ? `
                            <div class="restaurant-info" style="margin-top: 0.5rem; font-style: italic;">
                                "${restaurant.notes.substring(0, 100)}${restaurant.notes.length > 100 ? '...' : ''}"
                            </div>
                        ` : ''}
                        <div class="restaurant-actions">
                            <button class="btn-icon favorite ${restaurant.favorite ? 'active' : ''}" 
                                    onclick="toggleFavorite('${restaurant.id}')">
                                ${restaurant.favorite ? 'â¤ï¸ å·²æ”¶è—' : 'ğŸ¤ æ”¶è—'}
                            </button>
                            <button class="btn-icon" onclick="openEditModal('${restaurant.id}')">âœï¸ ç·¨è¼¯</button>
                            <button class="btn-icon" onclick="window.open('https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(restaurant.address)}', '_blank')">
                                ğŸ—ºï¸ åœ°åœ–
                            </button>
                            <button class="btn-icon" onclick="deleteRestaurant('${restaurant.id}')" style="color: #E74C3C;">ğŸ—‘ï¸ åˆªé™¤</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function updateStats() {
            const total = restaurants.length;
            const categories = new Set(restaurants.map(r => r.category)).size;
            const avgRating = total > 0 
                ? (restaurants.reduce((sum, r) => sum + r.rating, 0) / total).toFixed(1)
                : '0.0';
            const favorites = restaurants.filter(r => r.favorite).length;

            document.getElementById('totalRestaurants').textContent = total;
            document.getElementById('totalCategories').textContent = categories;
            document.getElementById('avgRating').textContent = avgRating;
            document.getElementById('favoriteCount').textContent = favorites;
        }
    </script>
</body>
</html>
